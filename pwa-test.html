<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWAåŠŸèƒ½æµ‹è¯• - OTISåŠ©æ‰‹</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .test-item {
      background: #f5f5f5;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #007AFF;
    }
    .status {
      font-weight: bold;
      margin-left: 10px;
    }
    .success { color: #34C759; }
    .error { color: #FF3B30; }
    .warning { color: #FF9500; }
    button {
      background: #007AFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056CC;
    }
    #results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª PWAåŠŸèƒ½æµ‹è¯•</h1>
  <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•OTISåŠ©æ‰‹çš„PWAåŠŸèƒ½ã€‚</p>
  
  <div class="test-item">
    <h3>Service WorkerçŠ¶æ€</h3>
    <div id="sw-status">æ£€æŸ¥ä¸­...</div>
    <button onclick="checkServiceWorker()">é‡æ–°æ£€æŸ¥</button>
  </div>
  
  <div class="test-item">
    <h3>Manifestæ–‡ä»¶</h3>
    <div id="manifest-status">æ£€æŸ¥ä¸­...</div>
    <button onclick="checkManifest()">é‡æ–°æ£€æŸ¥</button>
  </div>
  
  <div class="test-item">
    <h3>å®‰è£…æç¤º</h3>
    <div id="install-status">ç­‰å¾…æ£€æŸ¥...</div>
    <button onclick="triggerInstall()" id="install-btn" disabled>å®‰è£…PWA</button>
  </div>
  
  <div class="test-item">
    <h3>ç¦»çº¿åŠŸèƒ½</h3>
    <div id="offline-status">åœ¨çº¿çŠ¶æ€: <span id="online-indicator"></span></div>
    <button onclick="testOffline()">æµ‹è¯•ç¦»çº¿åŠŸèƒ½</button>
  </div>
  
  <div class="test-item">
    <h3>ç¼“å­˜çŠ¶æ€</h3>
    <div id="cache-status">æ£€æŸ¥ä¸­...</div>
    <button onclick="checkCache()">æ£€æŸ¥ç¼“å­˜</button>
    <button onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
  </div>
  
  <div id="results"></div>
  
  <script>
    let deferredPrompt;
    
    // æ£€æŸ¥åœ¨çº¿çŠ¶æ€
    function updateOnlineStatus() {
      const indicator = document.getElementById('online-indicator');
      if (navigator.onLine) {
        indicator.textContent = 'åœ¨çº¿';
        indicator.style.color = '#34C759';
      } else {
        indicator.textContent = 'ç¦»çº¿';
        indicator.style.color = '#FF3B30';
      }
    }
    
    // æ£€æŸ¥Service Worker
    function checkServiceWorker() {
      const statusEl = document.getElementById('sw-status');
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(registration => {
          if (registration) {
            statusEl.innerHTML = `<span class="status success">âœ… å·²æ³¨å†Œ</span><br>
              ä½œç”¨åŸŸ: ${registration.scope}<br>
              çŠ¶æ€: ${registration.active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}`;
          } else {
            statusEl.innerHTML = `<span class="status warning">âš ï¸ æœªæ³¨å†Œ</span>`;
          }
        });
      } else {
        statusEl.innerHTML = `<span class="status error">âŒ ä¸æ”¯æŒ</span>`;
      }
    }
    
    // æ£€æŸ¥Manifest
    async function checkManifest() {
      const statusEl = document.getElementById('manifest-status');
      
      try {
        const response = await fetch('/manifest.json');
        if (response.ok) {
          const manifest = await response.json();
          statusEl.innerHTML = `<span class="status success">âœ… å·²åŠ è½½</span><br>
            åº”ç”¨åç§°: ${manifest.name}<br>
            æ˜¾ç¤ºæ¨¡å¼: ${manifest.display}<br>
            å›¾æ ‡æ•°é‡: ${manifest.icons.length}`;
        } else {
          statusEl.innerHTML = `<span class="status error">âŒ åŠ è½½å¤±è´¥</span>`;
        }
      } catch (error) {
        statusEl.innerHTML = `<span class="status error">âŒ é”™è¯¯: ${error.message}</span>`;
      }
    }
    
    // æ£€æŸ¥ç¼“å­˜
    async function checkCache() {
      const statusEl = document.getElementById('cache-status');
      
      if ('caches' in window) {
        try {
          const cacheNames = await caches.keys();
          let totalSize = 0;
          let totalFiles = 0;
          
          for (const cacheName of cacheNames) {
            const cache = await caches.open(cacheName);
            const keys = await cache.keys();
            totalFiles += keys.length;
          }
          
          statusEl.innerHTML = `<span class="status success">âœ… å¯ç”¨</span><br>
            ç¼“å­˜æ•°é‡: ${cacheNames.length}<br>
            ç¼“å­˜æ–‡ä»¶: ${totalFiles} ä¸ª<br>
            ç¼“å­˜åç§°: ${cacheNames.join(', ')}`;
        } catch (error) {
          statusEl.innerHTML = `<span class="status error">âŒ é”™è¯¯: ${error.message}</span>`;
        }
      } else {
        statusEl.innerHTML = `<span class="status error">âŒ ä¸æ”¯æŒç¼“å­˜API</span>`;
      }
    }
    
    // æ¸…é™¤ç¼“å­˜
    async function clearCache() {
      if ('caches' in window) {
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
        alert('ç¼“å­˜å·²æ¸…é™¤');
        checkCache();
      }
    }
    
    // æµ‹è¯•ç¦»çº¿åŠŸèƒ½
    function testOffline() {
      const statusEl = document.getElementById('offline-status');
      statusEl.innerHTML += '<br>æ­£åœ¨æµ‹è¯•ç¦»çº¿åŠŸèƒ½...';
      
      // å°è¯•åŠ è½½ä¸€ä¸ªèµ„æº
      fetch('/styles.css', { cache: 'no-cache' })
        .then(response => {
          if (response.ok) {
            statusEl.innerHTML += '<br><span class="status success">âœ… èµ„æºåŠ è½½æˆåŠŸ</span>';
          } else {
            statusEl.innerHTML += '<br><span class="status warning">âš ï¸ èµ„æºåŠ è½½å¤±è´¥ï¼Œä½†å¯èƒ½æ¥è‡ªç¼“å­˜</span>';
          }
        })
        .catch(error => {
          statusEl.innerHTML += '<br><span class="status error">âŒ ç½‘ç»œé”™è¯¯ï¼Œæµ‹è¯•ç¦»çº¿ç¼“å­˜</span>';
        });
    }
    
    // è§¦å‘å®‰è£…
    function triggerInstall() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            document.getElementById('install-status').innerHTML = 
              '<span class="status success">âœ… ç”¨æˆ·æ¥å—å®‰è£…</span>';
          } else {
            document.getElementById('install-status').innerHTML = 
              '<span class="status warning">âš ï¸ ç”¨æˆ·æ‹’ç»å®‰è£…</span>';
          }
          deferredPrompt = null;
        });
      }
    }
    
    // ç›‘å¬å®‰è£…æç¤ºäº‹ä»¶
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('PWA: beforeinstallprompt äº‹ä»¶è§¦å‘');
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install-status').innerHTML =
        '<span class="status success">âœ… å¯ä»¥å®‰è£…</span>';
      document.getElementById('install-btn').disabled = false;
    });

    // æ£€æŸ¥PWAå®‰è£…æ¡ä»¶
    function checkPWAInstallability() {
      const checks = [
        {
          name: 'HTTPSæˆ–localhost',
          test: () => location.protocol === 'https:' || location.hostname === 'localhost'
        },
        {
          name: 'Service Workeræ³¨å†Œ',
          test: () => 'serviceWorker' in navigator
        },
        {
          name: 'Manifestæ–‡ä»¶',
          test: () => document.querySelector('link[rel="manifest"]') !== null
        },
        {
          name: 'æ˜¾ç¤ºæ¨¡å¼standalone',
          test: async () => {
            try {
              const response = await fetch('/manifest.json');
              const manifest = await response.json();
              return manifest.display === 'standalone';
            } catch {
              return false;
            }
          }
        }
      ];

      console.log('PWA: æ£€æŸ¥å®‰è£…æ¡ä»¶...');
      checks.forEach(async check => {
        const result = typeof check.test === 'function' ? await check.test() : check.test;
        console.log(`PWA: ${check.name}: ${result ? 'âœ…' : 'âŒ'}`);
      });
    }
    
    // ç›‘å¬å®‰è£…å®Œæˆäº‹ä»¶
    window.addEventListener('appinstalled', (evt) => {
      document.getElementById('install-status').innerHTML = 
        '<span class="status success">âœ… å·²å®‰è£…</span>';
    });
    
    // ç›‘å¬åœ¨çº¿çŠ¶æ€å˜åŒ–
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      updateOnlineStatus();
      checkServiceWorker();
      checkManifest();
      checkCache();
      checkPWAInstallability();

      // æ£€æŸ¥æ˜¯å¦å·²ç»å®‰è£…
      if (window.matchMedia('(display-mode: standalone)').matches) {
        document.getElementById('install-status').innerHTML =
          '<span class="status success">âœ… å·²å®‰è£…ï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰</span>';
      } else {
        // å»¶è¿Ÿæ£€æŸ¥å®‰è£…æç¤º
        setTimeout(() => {
          if (!deferredPrompt) {
            document.getElementById('install-status').innerHTML =
              '<span class="status warning">âš ï¸ å®‰è£…æç¤ºæœªå‡ºç°ï¼Œå¯èƒ½éœ€è¦æ»¡è¶³æ›´å¤šæ¡ä»¶</span>';
          }
        }, 3000);
      }
    });
  </script>
</body>
</html>
